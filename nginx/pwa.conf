server {
    listen 8766;

    # Requis pour SharedArrayBuffer (picoLLM-web, Cheetah-web WASM multi-thread)
    add_header Cross-Origin-Opener-Policy  "same-origin"   always;
    add_header Cross-Origin-Embedder-Policy "require-corp" always;
    add_header Cross-Origin-Resource-Policy "same-origin"  always;

    root  /usr/share/nginx/html;
    index index.html;

    # Token endpoint — proxied to ws-server (JWT issuance)
    location /token {
        proxy_pass http://livetranslator:8765;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # PWA — SPA routing
    location / {
        try_files $uri /index.html;
    }

    # Fichiers modèles (.pv, .pllm)
    # Note : add_header au niveau location écrase le niveau server → répétition nécessaire
    location /models/ {
        alias /usr/share/nginx/html/models/;
        add_header Cross-Origin-Opener-Policy  "same-origin"   always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Resource-Policy "same-origin"  always;
        add_header Cache-Control "public, max-age=604800, immutable" always;
    }

    gzip on;
    gzip_types text/css application/javascript application/json;
    gzip_min_length 1024;
}
